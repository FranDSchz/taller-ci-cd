name: CI - Node.js App

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build:
    name: üõ†Ô∏è Build
    runs-on: ubuntu-latest
    steps:
      - name: üì¶ Checkout repo
        uses: actions/checkout@v4

      - name: üîß Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: üì• Install dependencies
        run: npm install

      - name: ‚úÖ Slack success
        if: success()
        uses: rtCamp/action-slack-notify@v2
        env:
          SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK_URL }}
          SLACK_COLOR: good
          SLACK_TITLE: ":white_check_mark: Build exitoso"
          SLACK_MESSAGE: "Build del commit `${{ github.sha }}` completado correctamente en `${{ github.repository }}`."

      - name: ‚ùå Slack failure
        if: failure()
        uses: rtCamp/action-slack-notify@v2
        env:
          SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK_URL }}
          SLACK_COLOR: danger
          SLACK_TITLE: ":x: Fall√≥ el build"
          SLACK_MESSAGE: "El job de build fall√≥ en `${{ github.repository }}` para `${{ github.ref }}`."

  test:
    name: üß™ Test
    runs-on: ubuntu-latest
    needs: build
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
      - run: npm install
      - run: npm test

      - name: ‚úÖ Slack success
        if: success()
        uses: rtCamp/action-slack-notify@v2
        env:
          SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK_URL }}
          SLACK_COLOR: good
          SLACK_TITLE: ":white_check_mark: Tests exitosos"
          SLACK_MESSAGE: "Todos los tests pasaron en `${{ github.repository }}` para `${{ github.ref }}`."

      - name: ‚ùå Slack failure
        if: failure()
        uses: rtCamp/action-slack-notify@v2
        env:
          SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK_URL }}
          SLACK_COLOR: danger
          SLACK_TITLE: ":x: Fallaron los tests"
          SLACK_MESSAGE: "Algunos tests fallaron en `${{ github.repository }}` para `${{ github.ref }}`."

  lint:
    name: üßπ Lint
    runs-on: ubuntu-latest
    needs: build
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
      - run: npm install
      - run: npm run lint

      - name: ‚úÖ Slack success
        if: success()
        uses: rtCamp/action-slack-notify@v2
        env:
          SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK_URL }}
          SLACK_COLOR: good
          SLACK_TITLE: ":white_check_mark: Lint exitoso"
          SLACK_MESSAGE: "Linting completado sin errores en `${{ github.repository }}`."

      - name: ‚ùå Slack failure
        if: failure()
        uses: rtCamp/action-slack-notify@v2
        env:
          SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK_URL }}
          SLACK_COLOR: danger
          SLACK_TITLE: ":x: Fall√≥ el Lint"
          SLACK_MESSAGE: "Se encontraron errores de lint en `${{ github.repository }}` para `${{ github.ref }}`."
